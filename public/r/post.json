{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "post",
  "type": "registry:block",
  "title": "Lens Post",
  "description": "Displays a post from Lens Social Protocol, including the content, author, attachments, and engagement actions.",
  "dependencies": [
    "@lens-protocol/client@0.0.0-canary-20250725092937",
    "@lens-protocol/react@0.0.0-canary-20250725092937",
    "@lens-protocol/types@0.0.0-canary-20250725092937",
    "@lens-protocol/metadata@2.1.0",
    "@lens-chain/storage-client@1.0.6",
    "@lens-chain/sdk@1.0.3",
    "lucide-react",
    "strip-markdown@6.0.0",
    "react-markdown@9.0.3",
    "remark-gfm@4.0.1",
    "remark-breaks@4.0.0",
    "remark-linkify-regex@1.2.1",
    "viem@2.33.0",
    "wagmi@2.15.3"
  ],
  "registryDependencies": ["avatar", "button", "skeleton", "dialog", "tooltip", "dropdown-menu"],
  "files": [
    {
      "path": "registry/new-york/blocks/lens-post.tsx",
      "content": "\"use client\";\n\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/registry/new-york/ui/dropdown-menu\";\nimport { MouseEvent, useRef, useState } from \"react\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/registry/new-york/ui/avatar\";\nimport { Account, Post, PublicClient, SessionClient, TxHash } from \"@lens-protocol/react\";\nimport { Copy, Flag, MoreHorizontal, UserCircle2 } from \"lucide-react\";\nimport LensMarkdown from \"../components/common/lens-markdown\";\nimport LikeButton from \"@/registry/new-york/components/feed/likes/like-button\";\nimport ReferenceButton from \"@/registry/new-york/components/feed/references/reference-button\";\nimport CommentButton from \"@/registry/new-york/components/feed/comment/comment-button\";\nimport moment from \"moment/moment\";\nimport CollectButton from \"@/registry/new-york/components/feed/collects/collect-button\";\nimport TipButton from \"@/registry/new-york/components/feed/tips/tip-button\";\nimport { cn } from \"@/registry/new-york/lib/utils\";\nimport { parseUri, truncateAddress } from \"@/registry/new-york/lib/lens-utils\";\nimport { Button } from \"@/registry/new-york/ui/button\";\nimport BookmarkButton from \"@/registry/new-york/components/feed/bookmarks/bookmark-button\";\nimport { WalletClient } from \"viem\";\nimport CollectDialog, { CollectDialogRef } from \"@/registry/new-york/components/feed/collects/collect-dialog\";\nimport QuoteDialog, { QuoteDialogRef } from \"@/registry/new-york/components/feed/references/quote-dialog\";\nimport TipDialog, { TipDialogRef } from \"@/registry/new-york/components/feed/tips/tip-dialog\";\nimport { useLensPostContext } from \"@/registry/new-york/hooks/use-lens-post-context\";\nimport { useRouter } from \"next/navigation\";\nimport { Dialog, DialogContent } from \"@/registry/new-york/ui/dialog\";\nimport Image from \"next/image\";\n\ntype LensPostProps = {\n  /**\n   * The Lens Client used for making public and authenticated calls\n   */\n  lensClient?: PublicClient | SessionClient;\n\n  /**\n   * The wallet client from viem used to sign messages for authentication.\n   */\n  walletClient?: WalletClient;\n\n  /**\n   * Callback function that is called when the user clicks on a post.\n   */\n  onPostClick?: (post: Post) => void;\n\n  /**\n   * Callback function that is called when the user clicks on an account.\n   */\n  onAccountClick?: (account: Account) => void;\n\n  /**\n   * The URL pattern to use for generating post links if onPostClick is not provided.\n   * It should include `{slug}` as a placeholder for the post slug.\n   * If not provided, a default pattern (/posts/{slug}) will be used.\n   * * Example: `/posts/{slug}` or `https://example.com/posts/{slug}`\n   */\n  postUrlPattern?: string;\n\n  /**\n   * The URL pattern to use for generating account links if onAccountClick is not provided.\n   * It should include `{localName}` as a placeholder for the local name and optionally `{namespace}` for the namespace.\n   * If not provided, a default pattern (/u/{namespace}/{localName}) will be used.\n   * * Example: `/u/{localName}` or `https://example.com/u/{localName}`\n   */\n  accountUrlPattern?: string;\n\n  /**\n   * Callback function that is called when a repost is successful.\n   * It receives the transaction hash as an argument.\n   */\n  onRepostSuccess?: (txHash: TxHash) => void;\n\n  /**\n   * Optional additional class names to apply to the post container.\n   *\n   */\n  className?: string;\n};\n\nexport const LensPost = (props: LensPostProps) => {\n  const {\n    lensClient,\n    walletClient,\n    onPostClick,\n    onAccountClick,\n    postUrlPattern,\n    accountUrlPattern,\n    onRepostSuccess,\n    className,\n  } = props;\n\n  const collectDialog = useRef<CollectDialogRef>(null);\n  const quoteDialog = useRef<QuoteDialogRef>(null);\n  const tipDialog = useRef<TipDialogRef>(null);\n\n  const [lightboxOpen, setLightboxOpen] = useState(false);\n\n  const { post, loading } = useLensPostContext();\n  const router = useRouter();\n\n  if (!post) {\n    if (loading) {\n      return <></>; // TODO return skeleton\n    }\n    return null;\n  }\n\n  const author = post.author;\n  const name = author.metadata?.name ?? author.username?.localName ?? \"[anonymous]\";\n  const isPost = post.__typename === \"Post\";\n  const basePost = isPost ? post : post.repostOf;\n  const image = \"image\" in basePost.metadata ? basePost.metadata.image : null;\n  const imageUri = image ? parseUri(image.item) : null;\n\n  const collectAction =\n    post && \"actions\" in post && post.actions?.find(action => action.__typename === \"SimpleCollectAction\");\n\n  const onReportClick = () => {};\n\n  const onCopyClick = () => {\n    const postUrl = `https://hey.xyz/posts/${post.slug}`;\n    navigator.clipboard\n      .writeText(postUrl)\n      .then(() => {\n        console.log(\"Post link copied to clipboard:\", postUrl);\n      })\n      .catch(err => {\n        console.error(\"Failed to copy post link:\", err);\n      });\n  };\n\n  const handleAccountClick = (event: MouseEvent<HTMLButtonElement>) => {\n    event.stopPropagation();\n    onAccountClick?.(author);\n  };\n\n  const handlePostClick = (event: MouseEvent<HTMLButtonElement>) => {\n    // Allow text selection\n    if (window.getSelection()?.toString()) {\n      return;\n    }\n\n    event.preventDefault();\n\n    // If it's a repost, we assume the user wants to see the original post\n    const postUrl = postUrlPattern ? postUrlPattern.replace(\"{slug}\", basePost.slug) : `/posts/${basePost.slug}`;\n\n    if (onPostClick) {\n      onPostClick(basePost);\n    } else if (event.metaKey || event.ctrlKey || event.button === 1) {\n      window.open(postUrl, \"_blank\");\n    } else {\n      router.push(postUrl);\n    }\n  };\n\n  return (\n    <>\n      <article\n        onClick={handlePostClick}\n        className={cn(\"w-full p-4 flex flex-col gap-3 text-start cursor-pointer\", className)}\n      >\n        <div className=\"flex-grow flex justify-between flex-none\">\n          <div className=\"flex gap-2 w-full min-w-0\">\n            <button type=\"button\" onClick={handleAccountClick} className=\"cursor-pointer\">\n              <Avatar className=\"flex-none w-10 h-10\">\n                <AvatarImage src={author.metadata?.picture} alt={`${name}'s avatar`} />\n                <AvatarFallback>\n                  <UserCircle2 className=\"w-10 h-10 opacity-45\" />\n                </AvatarFallback>\n              </Avatar>\n            </button>\n            <div className=\"flex-grow flex flex-col min-w-0\">\n              <button type=\"button\" onClick={handleAccountClick} className=\"flex gap-2 w-full min-w-0\">\n                <span className=\"text-sm md:text-base font-semibold truncate cursor-pointer hover:underline\">\n                  {name}\n                </span>\n                {author.username?.localName ? (\n                  <span className=\"text-sm md:text-base text-muted-foreground flex-none  cursor-pointer hover:underline\">\n                    @{author.username.localName}\n                  </span>\n                ) : (\n                  <span className=\"text-sm md:text-base text-muted-foreground flex-none cursor-pointer hover:underline\">\n                    {truncateAddress(author.address)}\n                  </span>\n                )}\n              </button>\n              <abbr title={new Date(post.timestamp).toLocaleString()} className=\"text-xs opacity-65 no-underline\">\n                {moment(post.timestamp).fromNow(true)}\n              </abbr>\n            </div>\n          </div>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                className=\"w-8 h-8 active:outline-none focus-visible:outline-none hover:opacity-75 cursor-pointer rounded-full\"\n              >\n                <MoreHorizontal className=\"w-4 h-4 opacity-75\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent className=\"min-w-48\" side=\"bottom\">\n              <DropdownMenuItem className=\"focus:outline-none p-0\">\n                <button className=\"flex gap-2 items-center w-full p-2\" onClick={onReportClick} disabled={loading}>\n                  <Flag />\n                  Report post\n                </button>\n              </DropdownMenuItem>\n              <DropdownMenuItem className=\"focus:outline-none p-0\">\n                <button className=\"flex gap-2 items-center w-full p-2\" onClick={onCopyClick} disabled={loading}>\n                  <Copy className=\"w-4 h-4 inline\" />\n                  Copy link\n                </button>\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n        {isPost && post.metadata.__typename !== \"UnknownPostMetadata\" && (\n          <LensMarkdown content={post.metadata.content} className=\"text-sm md:text-base\" />\n        )}\n        {image && imageUri && (\n          <div className=\"mt-2 border rounded-lg\">\n            <Image\n              src={imageUri}\n              alt={image.altTag ?? \"\"}\n              className=\"w-full rounded-lg object-contain bg-gray-200 cursor-pointer\"\n              width={600}\n              height={400}\n              loading=\"lazy\"\n              onClick={event => {\n                event.stopPropagation();\n                setLightboxOpen(true);\n              }}\n            />\n          </div>\n        )}\n        <div className=\"flex gap-4 md:gap-8 items-center justify-between pe-2\">\n          <div className=\"flex items-center gap-4 md:gap-6 -ms-2\">\n            <CommentButton onClick={() => undefined} />\n            <LikeButton />\n            <ReferenceButton\n              lensClient={lensClient}\n              walletClient={walletClient}\n              onQuoteClick={() => quoteDialog.current?.open()}\n              onRepostSuccess={onRepostSuccess}\n            />\n            {collectAction && <CollectButton onClick={() => collectDialog.current?.open()} />}\n            <TipButton onClick={() => tipDialog.current?.open()} />\n          </div>\n          <BookmarkButton className=\"-me-2\" />\n        </div>\n      </article>\n      {collectAction && <CollectDialog ref={collectDialog} post={post} />}\n      <QuoteDialog ref={quoteDialog} post={post} createQuote={async (post, content) => undefined} />\n      <TipDialog ref={tipDialog} supportedTokens={[]} createTip={async () => undefined} />\n      <Dialog open={lightboxOpen} onOpenChange={setLightboxOpen}>\n        <DialogContent className=\"flex justify-center items-center max-h-full max-w-full bg-transparent border-none shadow-none\">\n          {lightboxOpen && image && imageUri && (\n            <img\n              src={imageUri}\n              alt={image.altTag ?? \"\"}\n              className=\"max-w-full max-h-full object-contain shadow-lg\"\n              loading=\"lazy\"\n            />\n          )}\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n};\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/components/common/lens-markdown.tsx",
      "content": "import stripMarkdown from \"strip-markdown\";\nimport remarkGfm from \"remark-gfm\";\nimport remarkBreaks from \"remark-breaks\";\n// @ts-ignore\nimport linkifyRegex from \"remark-linkify-regex\";\nimport { RegEx } from \"@/registry/new-york/lib/regex\";\nimport ReactMarkdown, { Components } from \"react-markdown\";\nimport { cn } from \"@/lib/utils\";\nimport LensMentionLink from \"@/registry/new-york/components/common/lens-mention-link\";\n\nconst LensMarkdown = ({ content, className }: { content: string; className?: string }) => {\n  const remarkPlugins = [\n    [\n      stripMarkdown,\n      {\n        keep: [\"blockquote\", \"code\", \"delete\", \"emphasis\", \"inlineCode\", \"link\", \"list\", \"listItem\", \"strong\"],\n      },\n    ],\n    remarkGfm,\n    remarkBreaks,\n    linkifyRegex(RegEx.URL),\n    linkifyRegex(RegEx.MENTION),\n    linkifyRegex(RegEx.HASHTAG),\n    linkifyRegex(RegEx.CASHTAG),\n  ];\n\n  const components: Components = {\n    a: (props: any) => {\n      // linkifyRegex will find @namespace/localname mentions and replace them with a link\n      // here we are defining how to render that link, removing the lens/ namespace if it exists\n      if (props.title?.startsWith(\"@\")) {\n        return <LensMentionLink username={props.title} />;\n      }\n\n      if (props.title?.startsWith(\"#\") || props.title?.startsWith(\"$\")) {\n        return <span className=\"font-bold\">{props.children}</span>;\n      }\n\n      return <a {...props} target=\"_blank\" rel=\"noopener noreferrer\" />;\n    },\n  };\n  return (\n    <>\n      <ReactMarkdown\n        remarkPlugins={remarkPlugins}\n        components={components}\n        className={cn(\"break-words hyphens-none line-clamp-6 whitespace-pre-wrap\", className)}\n      >\n        {content}\n      </ReactMarkdown>\n    </>\n  );\n};\n\nexport default LensMarkdown;\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/components/feed/likes/like-button.tsx",
      "content": "\"use client\";\n\nimport { MouseEvent } from \"react\";\nimport { Heart } from \"lucide-react\";\nimport { Button } from \"@/registry/new-york/ui/button\";\nimport { useLensPostContext } from \"@/registry/new-york/hooks/use-lens-post-context\";\nimport { cn } from \"@/registry/new-york/lib/utils\";\n\ntype LikeButtonProps = {\n  className?: string;\n  onSuccess?: () => void;\n  onError?: (error: Error) => void;\n};\n\nconst LikeButton = ({ className, onSuccess, onError }: LikeButtonProps) => {\n  const { post, loading: postLoading, toggleLike, optimistic } = useLensPostContext();\n\n  const operations = post && \"operations\" in post ? post.operations : null;\n  const stats = post && \"stats\" in post ? post.stats : null;\n\n  const onClick = async (event: MouseEvent<HTMLButtonElement>) => {\n    event.currentTarget.blur();\n    event.stopPropagation();\n\n    if (post?.__typename !== \"Post\") return;\n\n    try {\n      await toggleLike();\n      onSuccess?.();\n    } catch (e) {\n      if (onError) {\n        onError(e instanceof Error ? e : new Error(\"An unexpected error occurred while toggling like.\"));\n      } else {\n        console.error(\"An unexpected error occurred while toggling like:\", e);\n      }\n    }\n  };\n\n  return (\n    <div className=\"flex items-center\">\n      <Button\n        onClick={onClick}\n        disabled={postLoading}\n        variant=\"ghost\"\n        className={cn(\"w-8 h-8 active:outline-none focus-visible:outline-none cursor-pointer rounded-full\", className)}\n      >\n        {optimistic.liked || operations?.hasUpvoted ? (\n          <Heart className=\"text-primary\" fill=\"var(--primary)\" />\n        ) : (\n          <Heart className=\"opacity-85\" />\n        )}\n      </Button>\n      <span>{new Intl.NumberFormat().format(stats?.upvotes ?? 0)}</span>\n    </div>\n  );\n};\n\nexport default LikeButton;\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/components/feed/references/reference-button.tsx",
      "content": "import {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/registry/new-york/ui/dropdown-menu\";\nimport { AnyPost, Post, postId, PublicClient, SessionClient, TxHash } from \"@lens-protocol/react\";\nimport { repost } from \"@lens-protocol/client/actions\";\nimport { MouseEvent, useState } from \"react\";\nimport { CheckCircle, Loader, MessageCircle, Repeat2 } from \"lucide-react\";\nimport { Button } from \"@/registry/new-york/ui/button\";\nimport { handleOperationWith } from \"@lens-protocol/client/viem\";\nimport { WalletClient } from \"viem\";\nimport { useLensPostContext } from \"@/registry/new-york/hooks/use-lens-post-context\";\n\ntype ReferenceButtonProps = {\n  lensClient?: PublicClient | SessionClient;\n  walletClient?: WalletClient;\n  onQuoteClick: (post: AnyPost) => void;\n  onRepostSuccess?: (txHash: TxHash) => void;\n  onError?: (error: Error) => void;\n};\n\nconst ReferenceButton = ({\n  lensClient,\n  walletClient,\n  onQuoteClick,\n  onRepostSuccess,\n  onError,\n}: ReferenceButtonProps) => {\n  const { post, loading: postLoading } = useLensPostContext();\n\n  const [isDropdownMenuOpen, setIsDropdownMenuOpen] = useState(false);\n  const [isPosting, setIsPosting] = useState(false);\n  const [showSuccess, setShowSuccess] = useState(false);\n\n  const [numReposts, setNumReposts] = useState<number>(post && \"stats\" in post ? post.stats.reposts : 0);\n  const [numQuotes, setNumQuotes] = useState<number>(post && \"stats\" in post ? post.stats.quotes : 0);\n\n  const postToReference: Post | null | undefined = post?.__typename === \"Repost\" ? post.repostOf : post;\n\n  const onClick = (event: MouseEvent<HTMLButtonElement>) => {\n    event.currentTarget.blur();\n    event.stopPropagation();\n    setIsDropdownMenuOpen(true);\n  };\n\n  const onRepostClick = async (event: MouseEvent<HTMLButtonElement>) => {\n    event.stopPropagation();\n    setIsPosting(true);\n    try {\n      if (!post || !lensClient?.isSessionClient()) {\n        onError?.(new Error(\"Invalid post or lens client\"));\n        return;\n      }\n\n      setIsDropdownMenuOpen(false);\n\n      const res = await repost(lensClient, {\n        post: postId(post.id),\n      }).andThen(handleOperationWith(walletClient));\n\n      if (res.isErr()) {\n        throw res.error;\n      }\n\n      const txHash = res.value;\n      if (txHash) {\n        setNumReposts(prevNum => prevNum + 1);\n        onRepostSuccess?.(txHash);\n        setShowSuccess(true);\n        setTimeout(() => {\n          setShowSuccess(false);\n        }, 3000);\n        setShowSuccess(false);\n      }\n    } catch (error) {\n      if (error instanceof Error) {\n        onError?.(error);\n      }\n    } finally {\n      setIsPosting(false);\n    }\n  };\n\n  const handleQuoteClick = (event: MouseEvent<HTMLButtonElement>) => {\n    event.currentTarget.blur();\n    event.stopPropagation();\n    setIsDropdownMenuOpen(false);\n    if (!post) return;\n    onQuoteClick(post);\n  };\n\n  if (!post) return null;\n\n  return (\n    <div className=\"flex items-center\">\n      <DropdownMenu open={isDropdownMenuOpen} onOpenChange={setIsDropdownMenuOpen}>\n        <DropdownMenuTrigger asChild>\n          <Button\n            variant=\"ghost\"\n            disabled={postLoading || isPosting || showSuccess}\n            onClick={onClick}\n            className=\"w-8 h-8 active:outline-none focus-visible:outline-none hover:opacity-75 cursor-pointer rounded-full\"\n          >\n            {isPosting ? (\n              <Loader className=\"animate-spin w-4 h-4 text-muted-foreground\" />\n            ) : showSuccess ? (\n              <CheckCircle className=\"size-2\" />\n            ) : postToReference?.operations?.hasReposted ||\n              postToReference?.operations?.hasQuoted.optimistic ||\n              postToReference?.operations?.hasQuoted.onChain ? (\n              <Repeat2 className=\"size-[1.125rem]\" strokeWidth={3} stroke=\"var(--primary)\" />\n            ) : (\n              <Repeat2 className=\"size-[1.125rem]\" />\n            )}\n          </Button>\n        </DropdownMenuTrigger>\n        <DropdownMenuContent className=\"min-w-48\">\n          <DropdownMenuItem className=\"text-md focus:outline-none p-0\">\n            <button\n              className=\"flex gap-4 items-center w-full p-3\"\n              onClick={onRepostClick}\n              disabled={postLoading || isPosting}\n            >\n              <Repeat2 className=\"w-4 h-4 inline\" />\n              Repost\n            </button>\n          </DropdownMenuItem>\n          <DropdownMenuItem className=\"text-md focus:outline-none p-0\">\n            <button\n              className=\"flex gap-4 items-center w-full p-3\"\n              onClick={handleQuoteClick}\n              disabled={postLoading || isPosting}\n            >\n              <MessageCircle className=\"w-4 h-4 inline\" />\n              Quote\n            </button>\n          </DropdownMenuItem>\n        </DropdownMenuContent>\n      </DropdownMenu>\n      <span className=\"opacity-85\">{new Intl.NumberFormat().format(numQuotes + numReposts)}</span>\n    </div>\n  );\n};\n\nexport default ReferenceButton;\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/components/feed/references/quote-dialog.tsx",
      "content": "import { AnyPost, TxHash } from \"@lens-protocol/react\";\nimport { forwardRef, useImperativeHandle, useState } from \"react\";\n\nexport interface QuoteDialogRef {\n  open: () => void;\n  close: () => void;\n  isOpen: boolean;\n}\n\nexport interface QuoteDialogProps {\n  post: AnyPost;\n  createQuote: (post: AnyPost, content: string) => Promise<TxHash | undefined>;\n  onError?: (error: Error) => void;\n}\n\nconst QuoteDialog = forwardRef<QuoteDialogRef, QuoteDialogProps>(({ post, createQuote, onError }, ref) => {\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  useImperativeHandle(ref, () => ({\n    open: () => setDialogOpen(true),\n    close: () => setDialogOpen(false),\n    isOpen: dialogOpen,\n  }));\n\n  return <></>;\n});\n\nexport default QuoteDialog;\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/components/feed/bookmarks/bookmark-button.tsx",
      "content": "import { Button } from \"@/registry/new-york/ui/button\";\nimport { Bookmark } from \"lucide-react\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/registry/new-york/ui/tooltip\";\nimport { cn } from \"@/registry/new-york/lib/utils\";\nimport { useLensPostContext } from \"@/registry/new-york/hooks/use-lens-post-context\";\nimport { MouseEvent } from \"react\";\n\ntype BookmarkButtonProps = {\n  className?: string;\n  onSuccess?: () => void;\n  onError?: (error: Error) => void;\n};\n\nconst BookmarkButton = ({ className, onSuccess, onError }: BookmarkButtonProps) => {\n  const { post, loading: postLoading, toggleBookmark, optimistic } = useLensPostContext();\n\n  const operations = post && \"operations\" in post ? post.operations : null;\n\n  const onClick = async (event: MouseEvent<HTMLButtonElement>) => {\n    event.currentTarget.blur();\n    event.stopPropagation();\n\n    if (!post) return;\n\n    try {\n      await toggleBookmark();\n      onSuccess?.();\n    } catch (error) {\n      if (error instanceof Error && onError) {\n        onError(error);\n      }\n    }\n  };\n\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <Button\n            onClick={onClick}\n            disabled={postLoading}\n            variant=\"ghost\"\n            className={cn(\n              \"w-8 h-8 active:outline-none focus-visible:outline-none cursor-pointer rounded-full\",\n              className,\n            )}\n          >\n            {optimistic.bookmarked || operations?.hasBookmarked ? (\n              <Bookmark className=\"text-primary\" fill=\"var(--primary)\" />\n            ) : (\n              <Bookmark className=\"opacity-85\" />\n            )}\n          </Button>\n        </TooltipTrigger>\n        <TooltipContent>\n          {optimistic.bookmarked || operations?.hasBookmarked ? \"Remove bookmark\" : \"Bookmark post\"}\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  );\n};\n\nexport default BookmarkButton;\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/components/feed/comment/comment-button.tsx",
      "content": "\"use client\";\n\nimport { MouseEvent } from \"react\";\nimport { MessageCircle } from \"lucide-react\";\nimport { AnyPost } from \"@lens-protocol/react\";\nimport { Button } from \"@/registry/new-york/ui/button\";\nimport { useLensPostContext } from \"@/registry/new-york/hooks/use-lens-post-context\";\n\ntype CommentButtonProps = {\n  onClick: (post: AnyPost) => void;\n};\n\nconst CommentButton = ({ onClick }: CommentButtonProps) => {\n  const { post, loading: postLoading } = useLensPostContext();\n\n  const operations = post && \"operations\" in post ? post.operations : null;\n  const stats = post && \"stats\" in post ? post.stats : null;\n\n  const onButtonClick = (event: MouseEvent<HTMLButtonElement>) => {\n    event.currentTarget.blur();\n    event.stopPropagation();\n    if (!post) return;\n    onClick(post);\n  };\n\n  return (\n    <div className=\"flex items-center\">\n      <Button\n        variant=\"ghost\"\n        onClick={onButtonClick}\n        disabled={postLoading}\n        className=\"w-8 h-8 active:outline-none focus-visible:outline-none cursor-pointer rounded-full\"\n      >\n        {operations?.hasCommented?.optimistic || operations?.hasCommented?.onChain ? (\n          <MessageCircle className=\"text-primary\" fill=\"var(--primary)\" />\n        ) : (\n          <MessageCircle className=\"opacity-85\" />\n        )}\n      </Button>\n      <span className=\"opacity-85\">{new Intl.NumberFormat().format(stats?.comments ?? 0)}</span>\n    </div>\n  );\n};\n\nexport default CommentButton;\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/components/feed/collects/collect-button.tsx",
      "content": "\"use client\";\n\nimport { AnyPost } from \"@lens-protocol/react\";\nimport { ShoppingBag } from \"lucide-react\";\nimport { Button } from \"@/registry/new-york/ui/button\";\nimport { useLensPostContext } from \"@/registry/new-york/hooks/use-lens-post-context\";\nimport { MouseEvent } from \"react\";\n\ntype CollectButtonProps = {\n  onClick: (post: AnyPost) => void;\n};\n\nconst CollectButton = ({ onClick }: CollectButtonProps) => {\n  const { post, loading: postLoading, optimistic } = useLensPostContext();\n\n  const operations = post && \"operations\" in post ? post.operations : null;\n  const stats = post && \"stats\" in post ? post.stats : null;\n\n  const onButtonClick = (event: MouseEvent<HTMLButtonElement>) => {\n    event.currentTarget.blur();\n    event.stopPropagation();\n    if (!post) return;\n    onClick(post);\n  };\n\n  return (\n    <div className=\"flex items-center\">\n      <Button\n        onClick={onButtonClick}\n        disabled={postLoading}\n        variant=\"ghost\"\n        className=\"w-8 h-8 active:outline-none focus-visible:outline-none cursor-pointer rounded-full\"\n      >\n        {optimistic.collected || operations?.hasSimpleCollected ? (\n          <svg viewBox=\"0 0 20 22\" className=\"w-4 h-4\">\n            <g strokeWidth=\"1.5\" fill=\"none\" fillRule=\"evenodd\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path\n                d=\"M3,0 L0,4 L0,18 C0,19.1045695 0.8954305,20 2,20 L16,20 C17.1045695,20 18,19.1045695 18,18 L18,4 L15,0 L3,0 Z\"\n                stroke=\"var(--primary)\"\n                fill=\"var(--primary)\"\n                transform=\"translate(1 1)\"\n              />\n              <path\n                stroke=\"var(--primary)\"\n                fill=\"var(--background)\"\n                d=\"M3 0 0 4 18 4 15 0z\"\n                transform=\"translate(1 1)\"\n              />\n              <path stroke=\"var(--primary)\" d=\"M0 4 18 4\" transform=\"translate(1 1)\" />\n              <path\n                d=\"M13,8 C13,10.209139 11.209139,12 9,12 C6.790861,12 5,10.209139 5,8\"\n                stroke=\"var(--background)\"\n                transform=\"translate(1 1)\"\n              />\n            </g>\n          </svg>\n        ) : (\n          <ShoppingBag className=\"h-4 h-4\" />\n        )}\n      </Button>\n      <span className=\"opacity-85\">{new Intl.NumberFormat().format(stats?.collects ?? 0)}</span>\n    </div>\n  );\n};\n\nexport default CollectButton;\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/components/feed/collects/collect-dialog.tsx",
      "content": "import { AnyPost, TxHash, useAuthenticatedUser } from \"@lens-protocol/react\";\nimport { forwardRef, useEffect, useImperativeHandle, useState } from \"react\";\nimport { BoxIcon, CircleDollarSign, Clock, Snowflake, Users } from \"lucide-react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/registry/new-york/ui/dialog\";\nimport moment from \"moment/moment\";\nimport { Button } from \"@/registry/new-york/ui/button\";\nimport { Referral } from \"@/registry/new-york/lib/lens-post-provider\";\nimport { useLensPostContext } from \"@/registry/new-york/hooks/use-lens-post-context\";\nimport { truncateAddress } from \"@/registry/new-york/lib/lens-utils\";\nimport Link from \"next/link\";\nimport LensMentionLink from \"@/registry/new-york/components/common/lens-mention-link\";\n\nexport type CollectDialogRef = {\n  open: () => void;\n  close: () => void;\n  isOpen: boolean;\n};\n\ntype CollectDialogProps = {\n  post: AnyPost;\n  referrals?: Referral[];\n  onSuccess?: (txHash: TxHash) => void;\n  onError?: (error: Error) => void;\n};\n\nconst CollectDialog = forwardRef<CollectDialogRef, CollectDialogProps>(\n  ({ post, referrals, onSuccess, onError }, ref) => {\n    const { collect } = useLensPostContext();\n\n    const [collectDialogOpen, setCollectDialogOpen] = useState(false);\n    const [collecting, setCollecting] = useState(false);\n    const [collectEnded, setCollectEnded] = useState(false);\n    const [collectAvailable, setCollectAvailable] = useState(false);\n\n    const { data: user } = useAuthenticatedUser();\n\n    const action = \"actions\" in post && post.actions?.find(action => action.__typename === \"SimpleCollectAction\");\n    const operations = post && \"operations\" in post ? post.operations : null;\n    const stats = post && \"stats\" in post ? post.stats : null;\n\n    useImperativeHandle(ref, () => ({\n      open: () => setCollectDialogOpen(true),\n      close: () => setCollectDialogOpen(false),\n      isOpen: collectDialogOpen,\n    }));\n\n    useEffect(() => {\n      console.log(\"CollectDialog: \", { post, action });\n      if (!action) {\n        setCollectAvailable(false);\n        onError?.(new Error(\"This post is not collectable\"));\n        return;\n      }\n\n      if (action.endsAt) {\n        setCollectEnded(moment().isAfter(action.endsAt));\n      }\n\n      if (!operations?.canSimpleCollect || operations?.hasSimpleCollected) {\n        setCollectAvailable(false);\n        return;\n      }\n\n      if (action.collectLimit) {\n        setCollectAvailable((stats?.collects ?? 0) < action.collectLimit);\n      }\n    }, [action]);\n\n    const onCollectClick = async () => {\n      setCollecting(true);\n      try {\n        const txHash = await collect();\n        if (txHash) {\n          setCollectDialogOpen(false);\n        }\n      } catch (e: any) {\n        if (e instanceof Error) {\n          onError?.(e);\n        }\n      } finally {\n        setCollecting(false);\n      }\n    };\n\n    if (!action) {\n      return null;\n    }\n\n    return (\n      <Dialog open={collectDialogOpen} onOpenChange={setCollectDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Collect</DialogTitle>\n          </DialogHeader>\n          <div className=\"flex flex-col gap-2\">\n            <div className=\"text-lg font-bold py-3\">\n              {\"collectibleMetadata\" in post && post.collectibleMetadata.name ? (\n                post.collectibleMetadata.name\n              ) : (\n                <span>\n                  Post by{\" \"}\n                  <LensMentionLink\n                    username={post.author.username?.value}\n                    className=\"!font-bold\"\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                  />\n                </span>\n              )}\n            </div>\n            {action.payToCollect && (\n              <div className=\"flex gap-2.5 items-center\">\n                <CircleDollarSign className=\"w-7 h-7\" />\n                <span className=\"font-bold\">\n                  <span className=\"text-xl\">{action.payToCollect.amount.value}</span>{\" \"}\n                  {action.payToCollect.amount.asset.symbol}\n                </span>\n              </div>\n            )}\n            <div className=\"flex gap-4 items-center pl-1.5\">\n              <BoxIcon className=\"w-4 h-4 opacity-60\" />\n              <span>\n                <Link\n                  href={`https://lenscan.io/nfts/${action.collectNftAddress}`}\n                  className=\"font-semibold\"\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                >\n                  {truncateAddress(action.collectNftAddress, 10)}\n                </Link>\n              </span>\n            </div>\n            <div className=\"flex gap-4 items-center pl-1.5\">\n              <Users className=\"w-4 h-4 opacity-60\" />\n              <span>\n                <span className=\"font-semibold\">{new Intl.NumberFormat().format(stats?.collects ?? 0)}</span>{\" \"}\n                {stats?.collects === 1 ? \"collector\" : \"collectors\"}\n              </span>\n            </div>\n            {action.collectLimit && (\n              <div className=\"flex gap-4 items-center pl-1.5\">\n                <Snowflake className=\"w-4 h-4 opacity-60\" />\n                <span>\n                  <span className=\"font-semibold\">\n                    {new Intl.NumberFormat().format(action.collectLimit - (stats?.collects ?? 0))} of{\" \"}\n                    {action.collectLimit}\n                  </span>{\" \"}\n                  remaining\n                </span>\n              </div>\n            )}\n            {action.endsAt && (\n              <div className=\"flex gap-4 items-center pl-1.5\">\n                <Clock className=\"w-4 h-4 opacity-60\" />\n                <abbr className=\"!border-b-0 no-underline\" title={moment(action.endsAt).format(\"LLL\")}>\n                  {collectEnded ? \"Ended \" : \"Ends \"}{\" \"}\n                  <span className=\"font-semibold\">{moment(action.endsAt).fromNow()}</span>\n                </abbr>\n              </div>\n            )}\n            <div className=\"flex justify-end pt-2\">\n              <Button\n                size=\"lg\"\n                className=\"font-bold\"\n                onClick={onCollectClick}\n                disabled={collecting || collectEnded || !collectAvailable}\n              >\n                {collecting ? (\n                  <span className=\"loader\"></span>\n                ) : !user?.address ? (\n                  \"Log in to collect\"\n                ) : operations?.hasSimpleCollected ? (\n                  \"Collected\"\n                ) : collectEnded ? (\n                  \"No longer available\"\n                ) : collectAvailable ? (\n                  action.payToCollect ? (\n                    `Collect for ${action.payToCollect.amount.value} ${action.payToCollect.amount.asset.symbol}`\n                  ) : (\n                    \"Collect for free\"\n                  )\n                ) : (\n                  \"Unable to collect\"\n                )}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    );\n  },\n);\n\nexport default CollectDialog;\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/components/feed/tips/tip-button.tsx",
      "content": "\"use client\";\n\nimport { AnyPost } from \"@lens-protocol/react\";\nimport { MouseEvent } from \"react\";\nimport { CircleDollarSign } from \"lucide-react\";\nimport { Button } from \"@/registry/new-york/ui/button\";\nimport { useLensPostContext } from \"@/registry/new-york/hooks/use-lens-post-context\";\n\ninterface Props {\n  onClick: (post: AnyPost) => void;\n}\n\nconst TipButton = ({ onClick }: Props) => {\n  const { post, loading: postLoading } = useLensPostContext();\n\n  const operations = post && \"operations\" in post ? post.operations : null;\n  const stats = post && \"stats\" in post ? post.stats : null;\n\n  const handleClick = (event: MouseEvent<HTMLButtonElement>) => {\n    event.currentTarget.blur();\n    event.stopPropagation();\n    if (!post) return;\n    // onClick(post);\n  };\n\n  if (!post) return null;\n\n  return (\n    <div className=\"flex items-center\">\n      <Button\n        variant=\"ghost\"\n        disabled={postLoading || !operations?.canTip}\n        onClick={handleClick}\n        className=\"w-8 h-8 active:outline-none focus-visible:outline-none cursor-pointer rounded-full\"\n      >\n        {operations?.hasTipped ? (\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            viewBox=\"0 0 24 24\"\n            fill=\"var(--primary)\"\n            stroke=\"var(--background)\"\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n            className=\"w-4 h-4\"\n          >\n            <circle cx=\"12\" cy=\"12\" r=\"12\" />\n            <path d=\"M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8\" strokeWidth=\"2\" />\n            <path d=\"M12 18V6\" strokeWidth=\"2\" />\n          </svg>\n        ) : (\n          <CircleDollarSign className=\"w-4 h-4\" />\n        )}\n      </Button>\n      <span className=\"opacity-85\">{new Intl.NumberFormat().format(stats?.tips ?? 0)}</span>\n    </div>\n  );\n};\n\nexport default TipButton;\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/components/feed/tips/tip-dialog.tsx",
      "content": "import {\n  Erc20Amount,\n  evmAddress,\n  NativeAmount,\n  PaymentSource,\n  TxHash,\n  useAuthenticatedUser,\n  useSessionClient,\n} from \"@lens-protocol/react\";\nimport { forwardRef, useEffect, useImperativeHandle, useState } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/registry/new-york/ui/dialog\";\nimport { fetchBalancesBulk } from \"@lens-protocol/client/actions\";\nimport {\n  Select,\n  SelectContent,\n  SelectGroup,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/registry/new-york/ui/select\";\nimport { useAccount } from \"wagmi\";\n\nexport interface TipDialogRef {\n  open: () => void;\n  close: () => void;\n  isOpen: boolean;\n}\n\nexport interface TipDialogProps {\n  supportedTokens: string[];\n  createTip: (source: PaymentSource, amount: string, tokenAddress: string) => Promise<TxHash | undefined>;\n  onError?: (error: Error) => void;\n}\n\nconst NATIVE_TOKEN = \"0x000000000000000000000000000000000000800A\";\n\nconst TipDialog = forwardRef<TipDialogRef, TipDialogProps>(({ supportedTokens, createTip, onError }, ref) => {\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [balances, setBalances] = useState<(Erc20Amount | NativeAmount)[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<Error | null>(null);\n  const [selectedTokenAddress, setSelectedTokenAddress] = useState<string>();\n  const [inputValue, setInputValue] = useState<string>(\"\");\n  const [balance, setBalance] = useState<string>(\"0\");\n  const [paymentSource, setPaymentSource] = useState<PaymentSource>(PaymentSource.Signer);\n\n  const { data: session } = useSessionClient();\n  const { data: user } = useAuthenticatedUser();\n  const { address } = useAccount();\n\n  const account = user?.address;\n\n  useImperativeHandle(ref, () => ({\n    open: () => setDialogOpen(true),\n    close: () => setDialogOpen(false),\n    isOpen: dialogOpen,\n  }));\n\n  const getAddressFromBalance = (balance: Erc20Amount | NativeAmount) => {\n    return balance.__typename === \"NativeAmount\" ? NATIVE_TOKEN : balance.asset.contract.address;\n  };\n\n  useEffect(() => {\n    if (!dialogOpen || !session?.isSessionClient() || !address || !account) return;\n    setIsLoading(true);\n\n    const fetchBalances = async () => {\n      try {\n        const res = await fetchBalancesBulk(session, {\n          address: paymentSource === PaymentSource.Account ? account : evmAddress(address),\n          tokens: supportedTokens,\n          includeNative: true,\n        });\n\n        if (res.isErr()) {\n          throw res.error;\n        }\n\n        const accountBalances = res.value.filter(\n          balance => balance.__typename === \"NativeAmount\" || balance.__typename === \"Erc20Amount\",\n        );\n        if (!selectedTokenAddress) {\n          if (accountBalances[0].__typename === \"NativeAmount\") {\n            setSelectedTokenAddress(NATIVE_TOKEN);\n          } else {\n            setSelectedTokenAddress(accountBalances[0]?.asset.contract.address);\n          }\n        }\n        setBalances(accountBalances);\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    fetchBalances().catch(err => {\n      console.error(\"Error fetching balances:\", err);\n      setError(err);\n    });\n  }, [session, dialogOpen, address, account, paymentSource, selectedTokenAddress]);\n\n  useEffect(() => {\n    if (!balances.length || !selectedTokenAddress) {\n      setBalance(\"0\");\n      return;\n    }\n    const balance =\n      selectedTokenAddress === NATIVE_TOKEN\n        ? balances.find(b => b.__typename === \"NativeAmount\")\n        : balances.find(b => b.asset.contract.address === selectedTokenAddress);\n    setBalance(balance?.value || \"0\");\n  }, [balances, selectedTokenAddress]);\n\n  const onSubmitClick = async () => {\n    if (!selectedTokenAddress || !inputValue) {\n      onError?.(new Error(\"Token and amount cannot be falsy\"));\n      return;\n    }\n\n    setIsSubmitting(true);\n\n    try {\n      await createTip(paymentSource, inputValue, selectedTokenAddress);\n      setDialogOpen(false);\n      setInputValue(\"\");\n    } catch (e) {\n      if (e instanceof Error) {\n        onError?.(e);\n      }\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const onPaymentSourceChange = (value: PaymentSource) => {\n    setPaymentSource(value);\n    setSelectedTokenAddress(NATIVE_TOKEN);\n    setInputValue(\"\");\n  };\n\n  return (\n    <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n      <DialogContent className=\"max-w-xl\">\n        <DialogHeader className=\"text-left border-b pb-4\">\n          <DialogTitle>Send a tip</DialogTitle>\n        </DialogHeader>\n        <div className=\"flex flex-col gap-4 min-w-0\">\n          {(error || (!isLoading && !balances.length)) && (\n            <div className=\"py-4 flex gap-4 items-center\">\n              <span className=\"text-red-500\">No tokens available</span>\n            </div>\n          )}\n\n          {isLoading ? (\n            <div className=\"flex justify-center py-12\">\n              <span className=\"loader\"></span>\n            </div>\n          ) : (\n            balances.length && (\n              <div className=\"flex flex-col gap-4 min-w-0\">\n                <Select value={paymentSource} onValueChange={onPaymentSourceChange}>\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Source\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectGroup>\n                      <SelectItem key={PaymentSource.Signer} value={PaymentSource.Signer}>\n                        from wallet\n                      </SelectItem>\n                      <SelectItem key={PaymentSource.Account} value={PaymentSource.Account}>\n                        from account\n                      </SelectItem>\n                    </SelectGroup>\n                  </SelectContent>\n                </Select>\n                <Select value={selectedTokenAddress} onValueChange={setSelectedTokenAddress}>\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select a token\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectGroup>\n                      {balances.map(balance => (\n                        <SelectItem\n                          key={getAddressFromBalance(balance)}\n                          value={getAddressFromBalance(balance)}\n                          disabled={balance.value === \"0\"}\n                        >\n                          {balance.asset.name} ({balance.asset.symbol})\n                        </SelectItem>\n                      ))}\n                    </SelectGroup>\n                  </SelectContent>\n                </Select>\n                <div className=\"flex gap-4\">\n                  <input\n                    type=\"number\"\n                    placeholder=\"amount\"\n                    value={inputValue}\n                    onChange={e => setInputValue(e.target.value)}\n                    className=\"p-4 border rounded flex-grow\"\n                    disabled={isLoading}\n                  />\n                  <button\n                    className=\"flex-none btn-secondary !py-3 !px-6 !text-xl\"\n                    onClick={() => setInputValue(balance)}\n                  >\n                    max\n                  </button>\n                </div>\n\n                <div className=\"flex gap-8 justify-between\">\n                  <span className=\"text-lg truncate opacity-80\">\n                    balance:{\" \"}\n                    {parseFloat(balance).toLocaleString(undefined, {\n                      maximumFractionDigits: 6,\n                      useGrouping: false,\n                    })}\n                    {balance.split(\".\")[1]?.length > 6 ? \"…\" : \"\"}\n                  </span>\n                  <button className=\"btn flex-none !py-4\" onClick={onSubmitClick} disabled={isSubmitting}>\n                    {isSubmitting ? <span className=\"loader\"></span> : \"send\"}\n                  </button>\n                </div>\n              </div>\n            )\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n});\n\nexport default TipDialog;\n",
      "type": "registry:component"
    },
    {
      "path": "registry/new-york/lib/lens-utils.ts",
      "content": "export const ZeroAddress = \"0x0000000000000000000000000000000000000000\";\nexport const NATIVE_TOKEN = \"0x000000000000000000000000000000000000800A\";\n\n/**\n * Truncate a string to a maximum length, adding an ellipsis in the middle\n * @param address The string to truncate\n * @param maxLength The maximum length of the truncated string, excluding the ellipsis and 0x prefix\n */\nexport const truncateAddress = (address: string, maxLength: number = 8): string => {\n  if (address.length <= maxLength) {\n    return address;\n  }\n  const ellipsis = \"…\";\n  const startLength = Math.ceil((maxLength + ellipsis.length) / 2) + 1;\n  const endLength = Math.floor((maxLength + ellipsis.length) / 2);\n  return address.slice(0, startLength) + ellipsis + address.slice(address.length - endLength);\n};\n\nexport const getCidFromIpfsUrl = (ipfsUrl: string): string => {\n  if (!ipfsUrl.startsWith(\"ipfs://\")) throw new Error(\"IPFS urls must begin with ipfs://\");\n  return ipfsUrl.replace(\"ipfs://\", \"\").replace(/^\\/+|\\/+$/g, \"\");\n};\n\nexport const ipfsUrlToGatewayUrl = (\n  ipfsUrl: string | undefined,\n  gatewayDomain: string = \"https://ipfs.io/ipfs/\",\n): string | undefined => {\n  if (!ipfsUrl || ipfsUrl.length === 0 || !ipfsUrl.startsWith(\"ipfs://\")) return ipfsUrl;\n  const cid = getCidFromIpfsUrl(ipfsUrl);\n  const gatewayUrl = gatewayDomain + cid;\n  const path = ipfsUrl.split(cid)[1];\n  return path ? `${gatewayUrl}${path}` : gatewayUrl;\n};\n\nexport const arweaveUrlToGatewayUrl = (\n  arUrl: string | undefined,\n  gatewayDomain: string = \"https://arweave.net/\",\n): string | undefined => {\n  if (!arUrl || arUrl.length === 0 || !arUrl.startsWith(\"ar://\")) return arUrl;\n  const txId = arUrl.replace(\"ar://\", \"\");\n  return `${gatewayDomain}${txId}`;\n};\n\nexport const lensUrlToGatewayUrl = (\n  lensUrl: string | undefined,\n  gatewayDomain: string = \"https://api.grove.storage/\",\n): string | undefined => {\n  if (!lensUrl || lensUrl.length === 0 || !lensUrl.startsWith(\"lens://\")) return lensUrl;\n  const txId = lensUrl.replace(\"lens://\", \"\");\n  return `${gatewayDomain}${txId}`;\n};\n\n/**\n * Parse a URI and convert it to a gateway URL if it is an IPFS, Arweave, or Lens URL\n * @param uri The URI to parse\n */\nexport const parseUri = (uri: string | null | undefined): string | undefined => {\n  if (!uri) return undefined;\n\n  try {\n    const { protocol } = new URL(uri);\n    switch (protocol) {\n      case \"ipfs:\":\n        return ipfsUrlToGatewayUrl(uri);\n      case \"ar:\":\n        return arweaveUrlToGatewayUrl(uri);\n      case \"lens:\":\n        return lensUrlToGatewayUrl(uri);\n      default:\n        return uri;\n    }\n  } catch {\n    return undefined;\n  }\n};\n",
      "type": "registry:lib"
    },
    {
      "path": "registry/new-york/lib/lens-post-provider.tsx",
      "content": "import { createContext, ReactNode, useEffect, useState } from \"react\";\nimport {\n  AnyPost,\n  CreatePostRequest,\n  EvmAddress,\n  evmAddress,\n  PaymentSource,\n  Post,\n  postId as toPostId,\n  SessionClient,\n  TxHash,\n  useBookmarkPost,\n  usePost,\n  useUndoBookmarkPost,\n} from \"@lens-protocol/react\";\nimport { useWalletClient } from \"wagmi\";\nimport { executePostAction, post as createPost, repost as createRepost } from \"@lens-protocol/client/actions\";\nimport { handleOperationWith } from \"@lens-protocol/client/viem\";\nimport { useReactionToggle } from \"@/registry/new-york/hooks/use-reaction-toggle\";\nimport { NATIVE_TOKEN } from \"@/registry/new-york/lib/lens-utils\";\nimport { textOnly } from \"@lens-protocol/metadata\";\nimport { immutable, StorageClient } from \"@lens-chain/storage-client\";\nimport { chains } from \"@lens-chain/sdk/viem\";\n\nexport type OptimisticState = {\n  liked: boolean;\n  commented: boolean;\n  collected: boolean;\n  repostedOrQuoted: boolean;\n  tipped: boolean;\n  bookmarked: boolean;\n};\n\nexport type Referral = {\n  percent: number;\n  address: EvmAddress;\n};\n\ntype PostContextType = {\n  post: AnyPost | undefined | null;\n  loading: boolean;\n  error?: Error;\n  optimistic: OptimisticState;\n  toggleLike: () => Promise<void>;\n  comment: (content: string) => Promise<TxHash | undefined>;\n  collect: (paymentSource?: PaymentSource, referrals?: Referral[]) => Promise<TxHash | undefined>;\n  repost: () => Promise<TxHash | undefined>;\n  quote: (content: string) => Promise<TxHash | undefined>;\n  tip: (paymentSource: PaymentSource, amount: string, tokenAddress: string) => Promise<TxHash | undefined>;\n  toggleBookmark: () => Promise<void>;\n};\n\nexport const LensPostContext = createContext<PostContextType | undefined>(undefined);\n\nexport const LensPostProvider = ({\n  sessionClient,\n  postId,\n  children,\n  useTestnet = false,\n}: {\n  sessionClient: SessionClient | null | undefined;\n  postId: string;\n  children: ReactNode;\n  useTestnet?: boolean;\n}) => {\n  const { data, loading, error } = usePost({ post: postId });\n\n  const [post, setPost] = useState<Post | undefined | null>(data?.__typename === \"Repost\" ? data.repostOf : data);\n\n  const operations = post && \"operations\" in post ? post.operations : null;\n  const stats = post && \"stats\" in post ? post.stats : null;\n\n  const [optimistic, setOptimistic] = useState<OptimisticState>({\n    liked: operations?.hasUpvoted ?? false,\n    bookmarked: operations?.hasBookmarked ?? false,\n    collected: operations?.hasSimpleCollected ?? false,\n    tipped: operations?.hasTipped ?? false,\n    commented: operations?.hasCommented.optimistic ?? operations?.hasCommented.onChain ?? false,\n    repostedOrQuoted:\n      operations?.hasReposted.optimistic ??\n      operations?.hasReposted.onChain ??\n      operations?.hasQuoted.optimistic ??\n      operations?.hasQuoted.onChain ??\n      false,\n  });\n\n  useEffect(() => {\n    setPost(data?.__typename === \"Repost\" ? data.repostOf : data);\n  }, [data]);\n\n  const { data: walletClient } = useWalletClient();\n  const storageClient = StorageClient.create();\n  const { execute: toggleReaction } = useReactionToggle();\n  const { execute: bookmarkPost } = useBookmarkPost();\n  const { execute: undoBookmarkPost } = useUndoBookmarkPost();\n\n  const chain = useTestnet ? chains.testnet : chains.mainnet;\n\n  const switchChain = async () => {\n    await walletClient?.switchChain({ id: chain.id });\n  };\n\n  const toggleLike = async () => {\n    if (!post || !sessionClient?.isSessionClient()) return;\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      liked: !optimistic?.liked,\n    }));\n\n    const res = await toggleReaction({ post, session: sessionClient });\n\n    if (res.isErr()) {\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        liked: !optimistic?.liked,\n      }));\n      throw res.error;\n    }\n\n    setPost(prevPost => {\n      if (!prevPost) return null;\n      return {\n        ...prevPost,\n        stats: {\n          ...prevPost.stats,\n          upvotes: prevPost.stats.upvotes + (prevPost.operations?.hasUpvoted ? -1 : 1),\n        },\n        ...(prevPost.operations\n          ? {\n              operations: {\n                ...prevPost.operations,\n                hasUpvoted: !prevPost.operations?.hasUpvoted,\n              },\n            }\n          : {\n              operations: {\n                hasUpvoted: true,\n              },\n            }),\n      } as Post;\n    });\n  };\n\n  const comment = async (content: string): Promise<TxHash | undefined> => {\n    if (!post) {\n      throw new Error(\"Cannot comment without a post\");\n    }\n\n    if (!sessionClient?.isSessionClient() || !walletClient) {\n      throw new Error(\"Must be logged in to comment on a post\");\n    }\n\n    await switchChain();\n\n    const metadata = textOnly({ content });\n    const acl = immutable(chain.id);\n    const { uri } = await storageClient.uploadAsJson(metadata, { acl });\n    const postRequest: CreatePostRequest = {\n      contentUri: uri,\n      commentOn: {\n        post: post.id,\n      },\n    };\n\n    const previouslyCommented = optimistic.commented;\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      commented: true,\n    }));\n\n    const postResponse = await createPost(sessionClient, postRequest)\n      .andThen(handleOperationWith(walletClient))\n      .andThen(sessionClient.waitForTransaction);\n\n    if (postResponse.isErr()) {\n      console.error(\"Error posting comment:\", postResponse.error);\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        commented: previouslyCommented,\n      }));\n      throw postResponse.error;\n    }\n\n    return postResponse.value;\n  };\n\n  const collect = async (paymentSource?: PaymentSource, referrals?: Referral[]): Promise<TxHash | undefined> => {\n    if (!post) {\n      throw new Error(\"Cannot collect without a post\");\n    }\n\n    if (!sessionClient?.isSessionClient() || !walletClient) {\n      throw new Error(\"Must be logged in to collect a post\");\n    }\n\n    await switchChain();\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      collected: true,\n    }));\n\n    const res = await executePostAction(sessionClient, {\n      post: post.id,\n      action: {\n        simpleCollect: {\n          selected: true,\n          paymentSource,\n          referrals,\n        },\n      },\n    })\n      .andThen(handleOperationWith(walletClient))\n      .andThen(sessionClient.waitForTransaction);\n\n    if (res.isErr()) {\n      console.error(\"Error collecting post:\", res.error);\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        collected: false,\n      }));\n      throw res.error;\n    }\n\n    return res.value;\n  };\n\n  const repost = async (): Promise<TxHash | undefined> => {\n    if (!sessionClient?.isSessionClient() || !walletClient) {\n      throw new Error(\"Must be logged in to repost\");\n    }\n\n    await switchChain();\n\n    const previouslyReposted = optimistic.repostedOrQuoted;\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      repostedOrQuoted: true,\n    }));\n\n    const res = await createRepost(sessionClient, {\n      post: toPostId(postId),\n    })\n      .andThen(handleOperationWith(walletClient))\n      .andThen(sessionClient.waitForTransaction);\n\n    if (res.isErr()) {\n      console.error(\"Error reposting post:\", res.error);\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        repostedOrQuoted: previouslyReposted,\n      }));\n      throw res.error;\n    }\n\n    return res.value;\n  };\n\n  const quote = async (content: string): Promise<TxHash | undefined> => {\n    if (!post) {\n      throw new Error(\"Cannot quote without a post\");\n    }\n\n    if (!sessionClient?.isSessionClient() || !walletClient) {\n      throw new Error(\"Must be logged in to quote a post\");\n    }\n\n    await switchChain();\n\n    const metadata = textOnly({ content });\n    const acl = immutable(chain.id);\n    const { uri } = await storageClient.uploadAsJson(metadata, { acl });\n    const postRequest: CreatePostRequest = {\n      contentUri: uri,\n      quoteOf: {\n        post: post.id,\n      },\n    };\n\n    const previouslyQuoted = optimistic.repostedOrQuoted;\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      repostedOrQuoted: true,\n    }));\n\n    const postResponse = await createPost(sessionClient, postRequest)\n      .andThen(handleOperationWith(walletClient))\n      .andThen(sessionClient.waitForTransaction);\n\n    if (postResponse.isErr()) {\n      console.error(\"Error quoting post:\", postResponse.error);\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        repostedOrQuoted: previouslyQuoted,\n      }));\n      throw postResponse.error;\n    }\n\n    return postResponse.value;\n  };\n\n  const tip = async (\n    paymentSource: PaymentSource,\n    amount: string,\n    tokenAddress: string,\n  ): Promise<TxHash | undefined> => {\n    if (!post) {\n      throw new Error(\"Cannot tip without a post\");\n    }\n\n    if (!sessionClient?.isSessionClient() || !walletClient) {\n      throw new Error(\"Must be logged in to tip\");\n    }\n\n    await switchChain();\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      tipped: true,\n    }));\n\n    const res = await executePostAction(sessionClient, {\n      post: post.id,\n      action: {\n        tipping: {\n          paymentSource,\n          ...(tokenAddress === NATIVE_TOKEN ? { native: amount } : { value: amount, token: evmAddress(tokenAddress) }),\n        },\n      },\n    })\n      .andThen(handleOperationWith(walletClient))\n      .andThen(sessionClient.waitForTransaction);\n\n    if (res.isErr()) {\n      console.error(\"Error sending tip:\", res.error);\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        tipped: false,\n      }));\n      throw res.error;\n    }\n\n    return res.value;\n  };\n\n  const toggleBookmark = async () => {\n    if (!postId) return;\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      bookmarked: !optimistic.bookmarked,\n    }));\n\n    try {\n      if (operations?.hasBookmarked) {\n        await undoBookmarkPost({ post: toPostId(postId) });\n      } else {\n        await bookmarkPost({ post: toPostId(postId) });\n      }\n    } catch (error) {\n      console.error(\"Error bookmarking post:\", error);\n    }\n  };\n\n  return (\n    <LensPostContext.Provider\n      value={{\n        post,\n        toggleLike,\n        comment,\n        collect,\n        repost,\n        quote,\n        tip,\n        toggleBookmark,\n        loading,\n        error,\n        optimistic,\n      }}\n    >\n      {children}\n    </LensPostContext.Provider>\n  );\n};\n",
      "type": "registry:lib"
    },
    {
      "path": "registry/new-york/hooks/use-reaction-toggle.ts",
      "content": "import {\n  AddReactionMutation,\n  AddReactionRequest,\n  invariant,\n  AnyPost,\n  PostReactionType,\n  PublicClient,\n  SessionClient,\n  UndoReactionMutation,\n  UndoReactionRequest,\n} from \"@lens-protocol/react\";\nimport { UseAsyncTask, useAsyncTask } from \"@/registry/new-york/lib/tasks\";\nimport { ResultAsync } from \"@lens-protocol/types\";\n\nexport type ReactionToggleArgs = {\n  session: SessionClient | PublicClient;\n  post: AnyPost;\n};\n\ntype ReactionToggleResult = ResultAsync<void, unknown>;\n\nexport function hasUpvoted(post: AnyPost): boolean {\n  return \"operations\" in post && post.operations?.hasUpvoted === true;\n}\n\nexport const useReactionToggle = (): UseAsyncTask<ReactionToggleArgs, void, unknown> => {\n  return useAsyncTask((args: ReactionToggleArgs): ReactionToggleResult => {\n    invariant(args.session?.isSessionClient(), \"You must be authenticated to use this operation\");\n\n    return ResultAsync.fromPromise(\n      (async () => {\n        const post = args.post;\n        if (hasUpvoted(post)) {\n          const request: UndoReactionRequest = { post: post.id, reaction: PostReactionType.Upvote };\n          args.session?.mutation(UndoReactionMutation, { request });\n        } else {\n          const request: AddReactionRequest = { post: post.id, reaction: PostReactionType.Upvote };\n          args.session?.mutation(AddReactionMutation, { request });\n        }\n      })(),\n      error => {\n        console.error(\"Error toggling reaction:\", error);\n        return error;\n      },\n    );\n  });\n};\n",
      "type": "registry:hook"
    }
  ]
}
