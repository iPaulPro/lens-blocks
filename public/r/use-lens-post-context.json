{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "use-lens-post-context",
  "type": "registry:hook",
  "title": "Use Lens Post Context",
  "description": "A hook for queries and operations in a shared Lens post context",
  "dependencies": ["@lens-protocol/react@0.0.0-canary-20250725092937", "viem@2.33.0"],
  "files": [
    {
      "path": "registry/new-york/hooks/use-lens-post-context.tsx",
      "content": "import { useContext } from \"react\";\nimport { LensPostContext } from \"@/registry/new-york/lib/lens-post-provider\";\n\nexport const useLensPostContext = () => {\n  const context = useContext(LensPostContext);\n  if (!context) {\n    throw new Error(\"usePost must be used within a PostProvider\");\n  }\n  return context;\n};\n",
      "type": "registry:hook"
    },
    {
      "path": "registry/new-york/lib/lens-post-provider.tsx",
      "content": "import { createContext, ReactNode, useEffect, useState } from \"react\";\nimport {\n  AnyPost,\n  CreatePostRequest,\n  evmAddress,\n  PaymentSource,\n  Post,\n  postId as toPostId,\n  SessionClient,\n  TxHash,\n  useBookmarkPost,\n  usePost,\n  useUndoBookmarkPost,\n} from \"@lens-protocol/react\";\nimport { useWalletClient } from \"wagmi\";\nimport { executePostAction, post as createPost, repost as createRepost } from \"@lens-protocol/client/actions\";\nimport { handleOperationWith } from \"@lens-protocol/client/viem\";\nimport { useReactionToggle } from \"@/registry/new-york/hooks/use-reaction-toggle\";\nimport { NATIVE_TOKEN } from \"@/registry/new-york/lib/lens-utils\";\nimport { textOnly } from \"@lens-protocol/metadata\";\nimport { immutable, StorageClient } from \"@lens-chain/storage-client\";\nimport { chains } from \"@lens-chain/sdk/viem\";\n\ntype OptimisticState = {\n  liked: boolean;\n  commented: boolean;\n  collected: boolean;\n  repostedOrQuoted: boolean;\n  tipped: boolean;\n  bookmarked: boolean;\n};\n\ntype PostContextType = {\n  post: AnyPost | undefined | null;\n  loading: boolean;\n  error?: Error;\n  optimistic: OptimisticState;\n  toggleLike: () => Promise<void>;\n  comment: (content: string) => Promise<TxHash | undefined>;\n  collect: () => Promise<TxHash | undefined>;\n  repost: () => Promise<TxHash | undefined>;\n  quote: (content: string) => Promise<TxHash | undefined>;\n  tip: (source: PaymentSource, amount: string, tokenAddress: string) => Promise<TxHash | undefined>;\n  toggleBookmark: () => Promise<void>;\n};\n\nexport const LensPostContext = createContext<PostContextType | undefined>(undefined);\n\nexport const LensPostProvider = ({\n  sessionClient,\n  postId,\n  children,\n  useTestnet = false,\n}: {\n  sessionClient: SessionClient | null | undefined;\n  postId: string;\n  children: ReactNode;\n  useTestnet?: boolean;\n}) => {\n  const { data, loading, error } = usePost({ post: postId });\n\n  const [post, setPost] = useState<Post | undefined | null>(data?.__typename === \"Repost\" ? data.repostOf : data);\n\n  const operations = post && \"operations\" in post ? post.operations : null;\n  const stats = post && \"stats\" in post ? post.stats : null;\n\n  const [optimistic, setOptimistic] = useState<OptimisticState>({\n    liked: operations?.hasUpvoted ?? false,\n    bookmarked: operations?.hasBookmarked ?? false,\n    collected: operations?.hasSimpleCollected ?? false,\n    tipped: operations?.hasTipped ?? false,\n    commented: operations?.hasCommented.optimistic ?? operations?.hasCommented.onChain ?? false,\n    repostedOrQuoted:\n      operations?.hasReposted.optimistic ??\n      operations?.hasReposted.onChain ??\n      operations?.hasQuoted.optimistic ??\n      operations?.hasQuoted.onChain ??\n      false,\n  });\n\n  useEffect(() => {\n    setPost(data?.__typename === \"Repost\" ? data.repostOf : data);\n  }, [data]);\n\n  const { data: walletClient } = useWalletClient();\n  const storageClient = StorageClient.create();\n  const { execute: toggleReaction } = useReactionToggle();\n  const { execute: bookmarkPost } = useBookmarkPost();\n  const { execute: undoBookmarkPost } = useUndoBookmarkPost();\n\n  const chain = useTestnet ? chains.testnet : chains.mainnet;\n\n  const switchChain = async () => {\n    await walletClient?.switchChain({ id: chain.id });\n  };\n\n  const toggleLike = async () => {\n    if (!post || !sessionClient?.isSessionClient()) return;\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      liked: !optimistic?.liked,\n    }));\n\n    const res = await toggleReaction({ post, session: sessionClient });\n\n    if (res.isErr()) {\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        liked: !optimistic?.liked,\n      }));\n      throw res.error;\n    }\n\n    setPost(prevPost => {\n      if (!prevPost) return null;\n      return {\n        ...prevPost,\n        stats: {\n          ...prevPost.stats,\n          upvotes: prevPost.stats.upvotes + (prevPost.operations?.hasUpvoted ? -1 : 1),\n        },\n        ...(prevPost.operations\n          ? {\n              operations: {\n                ...prevPost.operations,\n                hasUpvoted: !prevPost.operations?.hasUpvoted,\n              },\n            }\n          : {\n              operations: {\n                hasUpvoted: true,\n              },\n            }),\n      } as Post;\n    });\n  };\n\n  const comment = async (content: string): Promise<TxHash | undefined> => {\n    if (!post) {\n      throw new Error(\"Cannot comment without a post\");\n    }\n\n    if (!sessionClient?.isSessionClient() || !walletClient) {\n      throw new Error(\"Must be logged in to comment on a post\");\n    }\n\n    await switchChain();\n\n    const metadata = textOnly({ content });\n    const acl = immutable(chain.id);\n    const { uri } = await storageClient.uploadAsJson(metadata, { acl });\n    const postRequest: CreatePostRequest = {\n      contentUri: uri,\n      commentOn: {\n        post: post.id,\n      },\n    };\n\n    const previouslyCommented = optimistic.commented;\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      commented: true,\n    }));\n\n    const postResponse = await createPost(sessionClient, postRequest)\n      .andThen(handleOperationWith(walletClient))\n      .andThen(sessionClient.waitForTransaction);\n\n    if (postResponse.isErr()) {\n      console.error(\"Error posting comment:\", postResponse.error);\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        commented: previouslyCommented,\n      }));\n      throw postResponse.error;\n    }\n\n    return postResponse.value;\n  };\n\n  const collect = async (): Promise<TxHash | undefined> => {\n    if (!post) {\n      throw new Error(\"Cannot collect without a post\");\n    }\n\n    if (!sessionClient?.isSessionClient() || !walletClient) {\n      throw new Error(\"Must be logged in to collect a post\");\n    }\n\n    await switchChain();\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      collected: true,\n    }));\n\n    const res = await executePostAction(sessionClient, {\n      post: post.id,\n      action: {\n        simpleCollect: {\n          selected: true,\n        },\n      },\n    })\n      .andThen(handleOperationWith(walletClient))\n      .andThen(sessionClient.waitForTransaction);\n\n    if (res.isErr()) {\n      console.error(\"Error collecting post:\", res.error);\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        collected: false,\n      }));\n      throw res.error;\n    }\n\n    return res.value;\n  };\n\n  const repost = async (): Promise<TxHash | undefined> => {\n    if (!sessionClient?.isSessionClient() || !walletClient) {\n      throw new Error(\"Must be logged in to repost\");\n    }\n\n    await switchChain();\n\n    const previouslyReposted = optimistic.repostedOrQuoted;\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      repostedOrQuoted: true,\n    }));\n\n    const res = await createRepost(sessionClient, {\n      post: toPostId(postId),\n    })\n      .andThen(handleOperationWith(walletClient))\n      .andThen(sessionClient.waitForTransaction);\n\n    if (res.isErr()) {\n      console.error(\"Error reposting post:\", res.error);\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        repostedOrQuoted: previouslyReposted,\n      }));\n      throw res.error;\n    }\n\n    return res.value;\n  };\n\n  const quote = async (content: string): Promise<TxHash | undefined> => {\n    if (!post) {\n      throw new Error(\"Cannot quote without a post\");\n    }\n\n    if (!sessionClient?.isSessionClient() || !walletClient) {\n      throw new Error(\"Must be logged in to quote a post\");\n    }\n\n    await switchChain();\n\n    const metadata = textOnly({ content });\n    const acl = immutable(chain.id);\n    const { uri } = await storageClient.uploadAsJson(metadata, { acl });\n    const postRequest: CreatePostRequest = {\n      contentUri: uri,\n      quoteOf: {\n        post: post.id,\n      },\n    };\n\n    const previouslyQuoted = optimistic.repostedOrQuoted;\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      repostedOrQuoted: true,\n    }));\n\n    const postResponse = await createPost(sessionClient, postRequest)\n      .andThen(handleOperationWith(walletClient))\n      .andThen(sessionClient.waitForTransaction);\n\n    if (postResponse.isErr()) {\n      console.error(\"Error quoting post:\", postResponse.error);\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        repostedOrQuoted: previouslyQuoted,\n      }));\n      throw postResponse.error;\n    }\n\n    return postResponse.value;\n  };\n\n  const tip = async (source: PaymentSource, amount: string, tokenAddress: string): Promise<TxHash | undefined> => {\n    if (!post) {\n      throw new Error(\"Cannot tip without a post\");\n    }\n\n    if (!sessionClient?.isSessionClient() || !walletClient) {\n      throw new Error(\"Must be logged in to tip\");\n    }\n\n    await switchChain();\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      tipped: true,\n    }));\n\n    const res = await executePostAction(sessionClient, {\n      post: post.id,\n      action: {\n        tipping: {\n          paymentSource: source,\n          ...(tokenAddress === NATIVE_TOKEN ? { native: amount } : { value: amount, token: evmAddress(tokenAddress) }),\n        },\n      },\n    })\n      .andThen(handleOperationWith(walletClient))\n      .andThen(sessionClient.waitForTransaction);\n\n    if (res.isErr()) {\n      console.error(\"Error sending tip:\", res.error);\n      setOptimistic(optimistic => ({\n        ...optimistic,\n        tipped: false,\n      }));\n      throw res.error;\n    }\n\n    return res.value;\n  };\n\n  const toggleBookmark = async () => {\n    if (!postId) return;\n\n    setOptimistic(optimistic => ({\n      ...optimistic,\n      bookmarked: !optimistic.bookmarked,\n    }));\n\n    try {\n      if (operations?.hasBookmarked) {\n        await undoBookmarkPost({ post: toPostId(postId) });\n      } else {\n        await bookmarkPost({ post: toPostId(postId) });\n      }\n    } catch (error) {\n      console.error(\"Error bookmarking post:\", error);\n    }\n  };\n\n  return (\n    <LensPostContext.Provider\n      value={{\n        post,\n        toggleLike,\n        comment,\n        collect,\n        repost,\n        quote,\n        tip,\n        toggleBookmark,\n        loading,\n        error,\n        optimistic,\n      }}\n    >\n      {children}\n    </LensPostContext.Provider>\n  );\n};\n",
      "type": "registry:lib"
    }
  ]
}
